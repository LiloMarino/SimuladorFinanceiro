"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[3150],{4735(e,n,o){o.r(n),o.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"desenvolvimento/async-vs-sync","title":"Diretrizes Async vs Sync","description":"Este projeto adota deliberadamente um modelo h\xedbrido (sync + async).","source":"@site/docs/desenvolvimento/async-vs-sync.md","sourceDirName":"desenvolvimento","slug":"/desenvolvimento/async-vs-sync","permalink":"/SimuladorFinanceiro/desenvolvimento/async-vs-sync","draft":false,"unlisted":false,"editUrl":"https://github.com/LiloMarino/SimuladorFinanceiro/tree/main/docs/docs/desenvolvimento/async-vs-sync.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Ciclo de Desenvolvimento com Banco de Dados","permalink":"/SimuladorFinanceiro/desenvolvimento/ciclo-banco-dados"},"next":{"title":"Contribuindo","permalink":"/SimuladorFinanceiro/desenvolvimento/contribuindo"}}');var i=o(62615),s=o(35756);const a={sidebar_position:5},d="Diretrizes Async vs Sync",c={},l=[{value:"Filosofia do Projeto",id:"filosofia-do-projeto",level:2},{value:"Conven\xe7\xf5es por Camada",id:"conven\xe7\xf5es-por-camada",level:2},{value:"Dom\xednio e Engine (S\xedncrono)",id:"dom\xednio-e-engine-s\xedncrono",level:3},{value:"Loop da Simula\xe7\xe3o (Thread Dedicada)",id:"loop-da-simula\xe7\xe3o-thread-dedicada",level:3},{value:"Estrutura do Loop",id:"estrutura-do-loop",level:4},{value:"Inicializa\xe7\xe3o da Thread",id:"inicializa\xe7\xe3o-da-thread",level:4},{value:"Camada de Transporte (Async)",id:"camada-de-transporte-async",level:3},{value:"Pontes entre Sync e Async (Regra de Ouro)",id:"pontes-entre-sync-e-async-regra-de-ouro",level:2},{value:"Async \u2192 Sync (event loop chamando c\xf3digo bloqueante)",id:"async--sync-event-loop-chamando-c\xf3digo-bloqueante",level:3},{value:"Sync \u2192 Async (thread chamando coroutine)",id:"sync--async-thread-chamando-coroutine",level:3},{value:"<code>notify()</code> \u2014 Fire and Forget (Padr\xe3o Oficial)",id:"notify--fire-and-forget-padr\xe3o-oficial",level:2},{value:"Implementa\xe7\xe3o Correta do Broker",id:"implementa\xe7\xe3o-correta-do-broker",level:3},{value:"Exemplo Real (Core S\xedncrono)",id:"exemplo-real-core-s\xedncrono",level:3},{value:"Diagrama Final de Arquitetura",id:"diagrama-final-de-arquitetura",level:2}];function t(e){const n={admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"diretrizes-async-vs-sync",children:"Diretrizes Async vs Sync"})}),"\n",(0,i.jsxs)(n.p,{children:["Este projeto adota ",(0,i.jsx)(n.strong,{children:"deliberadamente"})," um modelo h\xedbrido (",(0,i.jsx)(n.strong,{children:"sync + async"}),")."]}),"\n",(0,i.jsx)(n.p,{children:"A arquitetura \xe9 constru\xedda de forma que:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["o ",(0,i.jsx)(n.strong,{children:"core da simula\xe7\xe3o e do dom\xednio seja estritamente s\xedncrono"})]}),"\n",(0,i.jsxs)(n.li,{children:["o ",(0,i.jsx)(n.strong,{children:"c\xf3digo ass\xedncrono fique restrito \xe0 camada de transporte"})," (ASGI, WebSocket, Socket.IO)"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Este documento define as ",(0,i.jsx)(n.strong,{children:"regras oficiais"})," para essa separa\xe7\xe3o, evitando o vazamento de ",(0,i.jsx)(n.code,{children:"async/await"})," para o dom\xednio e garantindo integra\xe7\xe3o segura com o event loop."]}),"\n",(0,i.jsxs)(n.admonition,{title:"Decis\xe3o Arquitetural (ADR)",type:"note",children:[(0,i.jsxs)(n.p,{children:["Este documento registra uma ",(0,i.jsx)(n.strong,{children:"decis\xe3o arquitetural expl\xedcita"})," do projeto."]}),(0,i.jsxs)(n.p,{children:["Alterar o modelo sync/async descrito aqui ",(0,i.jsx)(n.strong,{children:"impacta diretamente o determinismo, o controle de estado e o modelo de execu\xe7\xe3o da simula\xe7\xe3o"})," e ",(0,i.jsx)(n.strong,{children:"n\xe3o deve ser feito sem reavaliar toda a arquitetura e seus trade-offs"}),"."]})]}),"\n",(0,i.jsx)(n.h2,{id:"filosofia-do-projeto",children:"Filosofia do Projeto"}),"\n",(0,i.jsxs)(n.p,{children:["O objetivo \xe9 ",(0,i.jsx)(n.strong,{children:"conter o c\xf3digo ass\xedncrono na camada de transporte"})," e impedir que conceitos como ",(0,i.jsx)(n.code,{children:"await"}),", ",(0,i.jsx)(n.code,{children:"asyncio"})," ou event loop contaminem o dom\xednio."]}),"\n",(0,i.jsx)(n.admonition,{title:"Princ\xedpio Chave",type:"info",children:(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:["O dom\xednio n\xe3o conhece ",(0,i.jsx)(n.code,{children:"asyncio"}),", event loop ou ",(0,i.jsx)(n.code,{children:"await"}),"."]}),(0,i.jsx)(n.br,{}),"\n","Async \xe9 um detalhe de infraestrutura, n\xe3o de regra de neg\xf3cio."]})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"conven\xe7\xf5es-por-camada",children:"Conven\xe7\xf5es por Camada"}),"\n",(0,i.jsx)(n.h3,{id:"dom\xednio-e-engine-s\xedncrono",children:"Dom\xednio e Engine (S\xedncrono)"}),"\n",(0,i.jsxs)(n.p,{children:["A l\xf3gica central da simula\xe7\xe3o \u2014 ",(0,i.jsx)(n.code,{children:"backend/features/simulation/*"}),", ",(0,i.jsx)(n.code,{children:"Simulation"}),", ",(0,i.jsx)(n.code,{children:"SimulationEngine"}),", ",(0,i.jsx)(n.code,{children:"UserManager"})," e reposit\xf3rios/DAO \u2014 ",(0,i.jsx)(n.strong,{children:"permanece intencionalmente s\xedncrona"})," (",(0,i.jsx)(n.code,{children:"def"}),")."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Motivos:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Executa regras de neg\xf3cio e c\xe1lculos determin\xedsticos"}),"\n",(0,i.jsx)(n.li,{children:"Possui estado mut\xe1vel controlado"}),"\n",(0,i.jsx)(n.li,{children:"N\xe3o depende de I/O ass\xedncrono"}),"\n",(0,i.jsx)(n.li,{children:"\xc9 mais simples de testar, depurar e raciocinar"}),"\n",(0,i.jsx)(n.li,{children:"Pode rodar de forma previs\xedvel em uma thread dedicada"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Exemplo:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"class SimulationEngine:\n    def calculate_portfolio_value(self, user_id: int) -> float:\n        positions = self.repository.get_positions(user_id)\n        return sum(p.quantity * p.current_price for p in positions)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"loop-da-simula\xe7\xe3o-thread-dedicada",children:"Loop da Simula\xe7\xe3o (Thread Dedicada)"}),"\n",(0,i.jsxs)(n.p,{children:["O loop de simula\xe7\xe3o roda em ",(0,i.jsx)(n.strong,{children:"uma thread pr\xf3pria"}),", separada do event loop ass\xedncrono da aplica\xe7\xe3o."]}),"\n",(0,i.jsxs)(n.p,{children:["Essa decis\xe3o ",(0,i.jsx)(n.strong,{children:"n\xe3o \xe9 uma prefer\xeancia estil\xedstica"}),", mas uma consequ\xeancia direta do modelo de execu\xe7\xe3o da simula\xe7\xe3o."]}),"\n",(0,i.jsx)(n.p,{children:"A simula\xe7\xe3o \xe9 um processo cont\xednuo que possui:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["um ",(0,i.jsx)(n.code,{children:"while"})," controlando explicitamente o ciclo de vida"]}),"\n",(0,i.jsxs)(n.li,{children:["execu\xe7\xe3o sequencial de ",(0,i.jsx)(n.code,{children:"next_tick()"})]}),"\n",(0,i.jsxs)(n.li,{children:["controle manual de tempo (",(0,i.jsx)(n.code,{children:"sleep"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["sincroniza\xe7\xe3o expl\xedcita de estado (",(0,i.jsx)(n.code,{children:"lock"}),")"]}),"\n",(0,i.jsx)(n.li,{children:"necessidade de previsibilidade e determinismo"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Esse tipo de execu\xe7\xe3o ",(0,i.jsx)(n.strong,{children:"\xe9 inerentemente s\xedncrono"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Uma thread Python executa c\xf3digo de forma ",(0,i.jsx)(n.strong,{children:"sequencial e bloqueante"}),".\nPortanto, o c\xf3digo que roda dentro dela ",(0,i.jsx)(n.strong,{children:"deve ser s\xedncrono"})," para manter simplicidade e previsibilidade."]}),"\n",(0,i.jsx)(n.p,{children:"Tornar esse loop ass\xedncrono exigiria:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["transformar ",(0,i.jsx)(n.code,{children:"next_tick()"})," em ",(0,i.jsx)(n.code,{children:"async"})]}),"\n",(0,i.jsxs)(n.li,{children:["propagar ",(0,i.jsx)(n.code,{children:"async/await"})," por todo o core"]}),"\n",(0,i.jsxs)(n.li,{children:["trocar ",(0,i.jsx)(n.code,{children:"threading.Lock"})," por ",(0,i.jsx)(n.code,{children:"asyncio.Lock"})]}),"\n",(0,i.jsx)(n.li,{children:"introduzir convers\xf5es constantes entre sync \u2194 async"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Tudo isso ",(0,i.jsx)(n.strong,{children:"aumentaria a complexidade"}),", sem trazer ganhos reais para esse tipo de simula\xe7\xe3o."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h4,{id:"estrutura-do-loop",children:"Estrutura do Loop"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import threading\nimport time\n\nclass SimulationLoopController:\n    def __init__(self, engine):\n        self.engine = engine\n        self.running = False\n        self.lock = threading.Lock()\n        self.tick_interval = 1.0\n\n    def run(self):\n        """Executa em thread dedicada"""\n        while self.running:\n            with self.lock:\n                self.engine.next_tick()  # C\xf3digo s\xedncrono\n            time.sleep(self.tick_interval)\n'})}),"\n",(0,i.jsx)(n.p,{children:"Esse modelo oferece:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["execu\xe7\xe3o previs\xedvel e determin\xedstica do ",(0,i.jsx)(n.code,{children:"tick"})]}),"\n",(0,i.jsx)(n.li,{children:"isolamento total do core em rela\xe7\xe3o ao event loop async"}),"\n",(0,i.jsxs)(n.li,{children:["uso direto de primitivas de sincroniza\xe7\xe3o (",(0,i.jsx)(n.code,{children:"threading.Lock"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["controle expl\xedcito de tempo sem depend\xeancia de ",(0,i.jsx)(n.code,{children:"asyncio"})]}),"\n",(0,i.jsx)(n.li,{children:"menor custo cognitivo e arquitetural"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h4,{id:"inicializa\xe7\xe3o-da-thread",children:"Inicializa\xe7\xe3o da Thread"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"thread = threading.Thread(\n    target=controller.run,\n    daemon=True,\n)\nthread.start()\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"camada-de-transporte-async",children:"Camada de Transporte (Async)"}),"\n",(0,i.jsxs)(n.p,{children:["FastAPI, ASGI, WebSocket e Socket.IO ",(0,i.jsx)(n.strong,{children:"s\xe3o ass\xedncronos por defini\xe7\xe3o"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Nessa camada, o uso de ",(0,i.jsx)(n.code,{children:"async"})," ",(0,i.jsx)(n.strong,{children:"\xe9 obrigat\xf3rio"}),", mas ",(0,i.jsx)(n.strong,{children:"n\xe3o deve vazar para o core"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Quando necess\xe1rio, o transporte faz a ponte chamando c\xf3digo s\xedncrono de forma segura."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Exemplo:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'@router.get("/portfolio/{user_id}")\nasync def get_portfolio(user_id: int):\n    portfolio = await asyncio.to_thread(\n        simulation_engine.get_portfolio,  # m\xe9todo s\xedncrono\n        user_id\n    )\n    return portfolio\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"pontes-entre-sync-e-async-regra-de-ouro",children:"Pontes entre Sync e Async (Regra de Ouro)"}),"\n",(0,i.jsx)(n.h3,{id:"async--sync-event-loop-chamando-c\xf3digo-bloqueante",children:"Async \u2192 Sync (event loop chamando c\xf3digo bloqueante)"}),"\n",(0,i.jsxs)(n.p,{children:["\u2714 ",(0,i.jsxs)(n.strong,{children:["Use ",(0,i.jsx)(n.code,{children:"asyncio.to_thread()"})]})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"result = await asyncio.to_thread(sync_function, arg1, arg2)\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Quando usar:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Endpoint FastAPI chamando dom\xednio"}),"\n",(0,i.jsx)(n.li,{children:"Handler WebSocket chamando engine"}),"\n",(0,i.jsx)(n.li,{children:"Qualquer c\xf3digo async chamando algo bloqueante"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"sync--async-thread-chamando-coroutine",children:"Sync \u2192 Async (thread chamando coroutine)"}),"\n",(0,i.jsxs)(n.p,{children:["\u2714 ",(0,i.jsxs)(n.strong,{children:["Use ",(0,i.jsx)(n.code,{children:"asyncio.run_coroutine_threadsafe()"})]})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"asyncio.run_coroutine_threadsafe(coro(), loop)\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Quando usar:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Loop de simula\xe7\xe3o notificando WebSocket"}),"\n",(0,i.jsx)(n.li,{children:"Core disparando eventos realtime"}),"\n",(0,i.jsx)(n.li,{children:"C\xf3digo s\xedncrono que precisa interagir com async"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.h2,{id:"notify--fire-and-forget-padr\xe3o-oficial",children:[(0,i.jsx)(n.code,{children:"notify()"})," \u2014 Fire and Forget (Padr\xe3o Oficial)"]}),"\n",(0,i.jsxs)(n.p,{children:["O broker realtime exp\xf5e um m\xe9todo ",(0,i.jsx)(n.strong,{children:"s\xedncrono"}),", propositalmente:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"def notify(event, payload, to=None) -> None\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Por qu\xea?"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"O core \xe9 s\xedncrono"}),"\n",(0,i.jsxs)(n.li,{children:["O core n\xe3o deve depender de ",(0,i.jsx)(n.code,{children:"await"})]}),"\n",(0,i.jsx)(n.li,{children:"Notifica\xe7\xe3o \xe9 efeito colateral, n\xe3o fluxo principal"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"implementa\xe7\xe3o-correta-do-broker",children:"Implementa\xe7\xe3o Correta do Broker"}),"\n",(0,i.jsxs)(n.p,{children:["A responsabilidade de fazer a ponte ",(0,i.jsx)(n.strong,{children:"sync \u2192 async"})," \xe9 ",(0,i.jsx)(n.strong,{children:"exclusivamente do broker"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class SocketBroker:\n    def notify(\n        self,\n        event: str,\n        payload: dict,\n        to: str | None = None,\n    ) -> None:\n        if self._loop is None:\n            raise RuntimeError("Event loop n\xe3o est\xe1 vinculado ao SocketBroker")\n\n        asyncio.run_coroutine_threadsafe(\n            self._async_notify(event, payload, to),\n            self._loop,\n        )\n\n    async def _async_notify(\n        self,\n        event: str,\n        payload: dict,\n        to: str | None,\n    ):\n        if to is not None:\n            await self.sio.emit(event, payload, to=to)\n        else:\n            await self.sio.emit(event, payload)\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h3,{id:"exemplo-real-core-s\xedncrono",children:"Exemplo Real (Core S\xedncrono)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class SimulationEngine:\n    def execute_trade(self, order):\n        trade = self.match_order(order)\n\n        # Fire-and-forget\n        self.broker.notify(\n            event="trade_executed",\n            payload={\n                "trade_id": trade.id,\n                "order_id": order.id,\n            },\n        )\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"diagrama-final-de-arquitetura",children:"Diagrama Final de Arquitetura"}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    Transport["Camada de Transporte (Async)<br>\n    FastAPI / WebSocket / Socket.IO<br>\n    async \u2192 sync<br>\n    asyncio.to_thread()"]\n\n    Domain["Dom\xednio e Engine (Sync)<br>\n    SimulationEngine / Loop / Core<br>\n    sync \u2192 async<br>\n    notify()"]\n\n    Broker["Realtime Broker<br>(Async Bridge)<br>\n    asyncio.run_coroutine_threadsafe()"]\n\n    EventLoop["Event Loop<br>(emit WebSocket)"]\n\n    Transport --\x3e Domain\n    Domain --\x3e Broker\n    Broker --\x3e EventLoop\n'})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(t,{...e})}):t(e)}}}]);